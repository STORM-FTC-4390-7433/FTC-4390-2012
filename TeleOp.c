#pragma config(Hubs,  S1, HTMotor,  HTMotor,  HTMotor,  HTMotor)
#pragma config(Sensor, S1,     ,               sensorI2CMuxController)
#pragma config(Motor,  mtr_S1_C1_1,     motorD,        tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C1_2,     motorE,        tmotorTetrix, openLoop, reversed, encoder)
#pragma config(Motor,  mtr_S1_C2_1,     motorF,        tmotorTetrix, openLoop, reversed, encoder)
#pragma config(Motor,  mtr_S1_C2_2,     motorG,        tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C3_1,     motorH,        tmotorNone, openLoop)
#pragma config(Motor,  mtr_S1_C3_2,     motorI,        tmotorNone, openLoop)
#pragma config(Motor,  mtr_S1_C4_1,     motorJ,        tmotorNone, openLoop)
#pragma config(Motor,  mtr_S1_C4_2,     motorK,        tmotorNone, openLoop)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#include "JoystickDriver.c"

#pragma platform(Tetrix)

//#define ENABLE_LATCH
//#define ENABLE_ARM
//#define ENABLE_CLAW


void omniDrive(int joyx, int joyy, float scale, int joyspin);
#ifdef ENABLE_LATCH
void latchrelease();
#endif
#ifdef ENABLE_ARM
void armMove(bool moveUp);
#endif

#define NORMAL_SCALE 1.0
#define SLOW_SCALE 0.5
float scale = NORMAL_SCALE;
task main() {
    while(true) {
        getJoystickSettings(joystick);

#ifdef ENABLE_ARM

        if(joy1Btn(7) && joy1Btn(5)) {
            //if both 7 and 5 are depressed DO NOTHING!
            writeDebugStreamLine("Both #5 and #7 depressed");
        } else if(joy1Btn(7)) {
            armMove(false);
            writeDebugStreamLine("joy1_btn 7 depressed; armMove false initiated");
        } else if(joy1Btn(5)) {
            //call arm movement function
            armMove(true);
            writeDebugStreamLine("joy1_btn 5 depressed; armMove true initiated");
	}

#endif

#ifdef ENABLE_LATCH

        //see if btn 8 is depressed, if so sets a scale factor for all movement calculations in omnidrive function
        if(joy1Btn(10)) {
            //Release Latch
            latchrelease();
        }

#endif

        if(joy1Btn(8)) {
            scale = SLOW_SCALE;
        } else {
            scale = NORMAL_SCALE;
        }
        omniDrive(joystick.joy1_x1, joystick.joy1_y1, scale, joystick.joy1_x2);
        if(joy1Btn(5)) {
            motor[motorH] = 50;
        }
        if (joy1Btn(7)) {
            motor[motorH]=-50;
	}

#ifdef ENABLE_CLAW

        switch(joystick.joy1_TopHat) {
        case 0:
        case 1:
        case 7:
            servo[servo1] = 40;
            break;

        case 5:
        case 4:
        case 3:
            servo[servo1] = -40;
            break;

        default:
            servo[servo1] = 0;
        }

#endif
    }
}

//int scale: multiplies by the scale factor to receive new speed
void omniDrive(int joyx, int joyy, float scale, int joyspin) {
    float x    = (100.0/128) * (float)joyx,
          y    = (100.0/128) * (float)joyy,
          spin = (50.0/128)  * (float)joyspin;

    int upRightSpeed = (x + y)  / sqrt(2);
    int upLeftSpeed  = (-x + y) / sqrt(2);

    motor[motorE] = (upRightSpeed + spin) * scale;
    motor[motorD] = (upRightSpeed - spin) * scale;
    motor[motorG] = (upLeftSpeed  + spin) * scale;
    motor[motorF] = (upLeftSpeed  - spin) * scale;
}

#ifdef ENABLE_LATCH

void latchrelease() {
    //write code when given a latch release mechanism design from mech
    writeDebugStreamLine("Latch Release initiated");
}

#endif

#ifdef ENABLE_ARM

void armMove(bool moveUp) {
    //Movement speed TBD
    const float armSpeed = 50;
    //Motor designation open to change
    if(moveUp) {
        motor[motorI] = armSpeed;
    } else {
        motor[motorI] = - armSpeed;
    }
}

#endif

